version: '3.7'

services:
  website:
     build:
        context: .
        dockerfile: Dockerfile_website
     ports:
        - '8000:8000'
     # Use -v2 for more reporting
     command: daphne -b 0.0.0.0 -p 8000 -v2 ascan.asgi:application
     working_dir: /ascan
     env_file:
        - '.env'
     depends_on:
        - postgres
        - omnivore
        - speechtractor
     volumes:
        - ./ascan:/ascan

  maintenance:
     build:
        context: .
        dockerfile: Dockerfile_website
     command: python3 maintenance.py -L WARNING
     working_dir: /ascan
     env_file:
        - '.env'
     volumes:
        - ./ascan:/ascan
     depends_on:
        - website # to get DB initialization

  scrapy:
     build:
        context: .
        dockerfile: Dockerfile_website
     command: scrapy crawl general -L INFO
     working_dir: /scrapies/genscrap
     env_file:
        - '.env'
     depends_on:
        - postgres
        - solr
        - redis
        - selenium
        - website
     volumes:
        - ./ascan:/ascan
        - ./pagecopies:/scrapies/pagecopies

  reddit:
     build:
        context: .
        dockerfile: Dockerfile_website
     command: python reddit_scraper.py -L WARNING
     working_dir: /scrapies
     env_file:
        - '.env'
     depends_on:
        - postgres
        - solr
        - website
     volumes:
        - ./ascan:/ascan

  omnivore:
     build:
        context: .
        dockerfile: Dockerfile_omnivore
     volumes:
        # Persist quicklisp in a named volume.
        - quicklisp:/root/quicklisp:Z
        - ./lisp-startup:/lisp/startup
        - ./textviews:/lisp/textviews
        - ./omnivore:/lisp/omnivore
     ports:
        # Map the original 4242 to 4243.
        - '4243:4242'
        # Expose Swank.
        - '4006:4005'
     command: 'sbcl --load /lisp/startup/lisp-startup-omnivore.lisp'
     # Make sbcl not exit immediately.
     tty: true
     depends_on:
        - solr

  speechtractor:
     build:
        context: .
        dockerfile: Dockerfile_stractor
     volumes:
        # Persist quicklisp in a named volume.
        - quicklisp:/root/quicklisp:Z
        - ./lisp-startup:/lisp/startup
        - ./speechtractor:/lisp/speechtractor
     ports:
        - '3757:3756'
        # Expose Swank.
        - '4007:4005'
     command: 'sbcl --load /lisp/startup/lisp-startup-stractor.lisp'
     # Make sbcl not exit immediately.
     tty: true

  postgres:
     image: 'postgres:12.2'
     volumes:
        - pgdata:/var/lib/postgresql/data:Z
     ports:
        # Map the original 5432 to 5433.
        - '5433:5432'
     env_file:
        - '.env'

  selenium:
     image: 'selenium/standalone-chrome:3.141.59'
     volumes:
        - /dev/shm:/dev/shm
     ports:
        - '4444:4444'
     env_file:
        - '.env'

   # Needed for Django Channels (and Celery when we use it).
  redis:
    image: 'redis:6.0-rc'
    command: 'redis-server /usr/local/etc/redis/redis.conf'
    volumes:
      - redisdata:/var/lib/redis/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - '6380:6379'

  solr:
     build:
        context: .
        dockerfile: Dockerfile_solr
     ports:
        # Map the original 8983 to 8984.
        - '8984:8983'
     volumes:
        # Kinda the documentation's suggestion to persist data.
        # A named volume is kept persistent by Docker behind the scenes.
        # (Z should facilitate living with SELinux?)
        - solrdata:/var/solr/:Z
        # Allow posting to Solr documents we've prepared with scripts.
        - ./processing-scripts:/processing-scripts

# Named volumes.
volumes:
   pgdata:
   quicklisp:
   redisdata:
   solrdata:
