{% extends 'scan/base.html' %}
{% load static %}
{% load bootstrap4 %}

{% block page_title %}{% if scan_phrase %}{{ scan_phrase }}{% else %}Searching{% endif %}{% endblock %}

{% block metas %}
{% if is_good and not result %}
<noscript>
<meta http-equiv="refresh" content="2">
</noscript>
{% endif %}
{% endblock %}

{% block scripts %}
<script type="application/javascript" src="{% static 'scan/js/chartist.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'scan/css/chartist.min.css' %}">
{% endblock %}

{% block container %}
<h2>{{ scan_phrase }}{% if job_id %} (job id: {{ job_id }}){% endif %}</h2>

{# If there is no result, show the status data #}
{% if not result %}
   {% if is_good %}
   <script type="text/javascript">window.SCAN_ID = {{ scan_id }}</script>
   <script type="application/javascript" src="{% static 'scan/js/scanprogress.js' %}"></script>

   <div class="alert alert-success" role="alert">
      <p>We are currently processing your request, please wait.</p>

      <p>If your browser doesn't refresh this page automatically, please
      <a href="">click here</a>
      after a moment.</p>
   </div>
   {% else %}
   <div class="alert alert-danger" role="alert">
      <p>Sorry, we experienced a problem with your request.</p>
      <ul>
         {% if form.errors %}
         {% for field in form %}
         {% for error in field.errors %}
         <li>{{ error|escape }}</li>
         {% endfor %}
         {% endfor %}
         {% for error in form.non_field_errors %}
         <li>{{ error|escape }}</li>
         {% endfor %}
         {% endif %}
      </ul>
   </div>
   {% endif %}

   <table class="table">
      <thead class="thead-light">
         <tr>
         <th scope="col">Item</th>
         <th scope="col">Information</th>
         </tr>
      </thead>
      <tbody>
         <tr>
         <th scope="row">Scan status</th>
         <td id='scan_phase'>{{ status_data.phase }}</td>
         </tr>
         <tr>
         <th scope="row">No. of failures</th>
         <td id='scan_fails'>{% if status_data.failures %}{{ status_data.failures }}{% else %}0{% endif %}</td>
         </tr>
         <tr>
         <th scope="row">Last page processed</th>
         <td id='scan_last_url'>{% if status_data.last_url %}{{ status_data.last_url }}{% else %}-{% endif %}</td>
         </tr>
         <tr>
         <th scope="row">at least % done (estimated)</th>
         <td id='scan_dl_proportion'>{% if status_data.dl_proportion %}{% widthratio status_data.dl_proportion 1 100 %}%{% else %}-{% endif %}</td>
         </tr>
         <tr>
         <th scope="row">Request stats</th>
         <td id='scan_req_stats'>{% if status_data.req_stats %}
            Search pages: {{ status_data.req_stats.searches }},
            content pages: {{ status_data.req_stats.crawls }}<br>
            Committed: {{ status_data.req_stats.commits }},
            waiting and being processed: {{ status_data.req_stats.wait_runs }},
            failed: {{ status_data.req_stats.fails }}<br>
            Estimated potential (max): {{ status_data.req_stats.future }}
            {% if status_data.req_stats.reddit_blocking %}<br>Waiting for Reddit API allowance...{% endif %}
            {% else %}-{% endif %}</td>
         </tr>
      </tbody>
   </table>

   <div>
      <form action="/scan/scaninfo/">
         <input type="hidden" value="{{ scan_id }}" name="job_id">
         <input type="hidden" value="1" name="terminate">
         <button type="submit" class="btn btn-secondary">Terminate the scan</button>
         </form>
   </div>
   <div id='go_to_results_options'>
   </div>
{# If we have the result, show it. #}
{% else %}
{% if result.sentCount == 0 %}
<div class="p-2">Sorry, we have no sufficient information for the specified parameters in the index.</div>
<noscript><a class="btn btn-primary" href="/">Try something different</a></noscript>
<script>document.write('<a class="btn btn-primary" href="javascript:history.go(-1)">Try something different</a>')</script>
{% endif %}

{% if possible_feedback %}
   <script type="text/javascript">
      window.FEEDBACK_SITE = '{{ possible_feedback.site }}'
      window.FEEDBACK_TAG = '{{ possible_feedback.tag }}'
   </script>
   <script type="application/javascript" src="{% static 'scan/js/feedback_prompt.js' %}"></script>
{% endif %}

<div class="card-columns">
{% if result.years %}
<div class="card">
  <div class="card-header">
    Time
  </div>
  <div class="chart">
  <div id="ct-chart-trend" class="ct-chart ct-golden-section"></div>
  </div>
</div>
{% endif %}

{% if result.sitesStats %}
<div class="card">
  <div class="card-header">
    Sites
  </div>
  <div id="ct-chart-sites" class="ct-chart ct-golden-section"></div>
</div>
{% endif %}

{% if result.typical %}
<div class="card">
  <div class="card-header">
    Typical samples
  </div>
       {% for sent in result.typical %}
       <div class="card-body p-2">
       <p class="card-text">{{ sent.text }}</p>
       <p class="card-text"><small class="text-muted">
          by {{ sent.author }}{% if sent.date %} ({{ sent.date }}){% endif %}
          at {{ sent.domain }}</small>
       <small><br><a href="{{ sent.url }}">{{ sent.url }}</a></small>
       {% include "widgets/feedback_prompt.html" with site_name=sent.domain %}
       </p>
       </div>
       {% endfor %}
</div>
{% endif %}

{% if result.phrases %}
<div class="card">
  <div class="card-header">
    Ordinary samples
  </div>
       {% for phrase in result.phrases %}
       <div class="card-body p-2">
          <h5 class="card-title">{{ phrase.text }}</h5>
          <ul>
             {% for sent in phrase.typical %}
             <li>
                <span class="card-text">{{ sent.text }}</span>
                <small class="text-muted">by {{ sent.author }}
                   {% if sent.date %} ({{ sent.date }}){% endif %}
                   at {{ sent.domain }}
                   <br><a href="{{ sent.url }}">{{ sent.url }}</a></small>
                {% include "widgets/feedback_prompt.html" with site_name=sent.domain %}
             </li>
             {% endfor %}
          </ul>
          {% if phrase.oldest %}
          <div class="px-3">
          <span class="text-muted">Oldest:</span>
          {% for sent in phrase.oldest %}
          <span class="card-text"><strong>({{ sent.date }})</strong>
             {{ sent.text }}</span>
          <small class="text-muted">by {{ sent.author }}
             at {{ sent.domain }}
             <br><a href="{{ sent.url }}">{{ sent.url }}</a></small>
          {% include "widgets/feedback_prompt.html" with site_name=sent.domain %}
          {% endfor %}
          </div>
          {% endif %}
       </div>
       {% endfor %}
</div>
{% endif %}

{% if result.topTerms %}
<div class="card">
  <div class="card-header">
    Top terms
  </div>
       <div class="card-body p-2">
       {% for term, freq in result.topTerms.items %}
       {% if freq > 50 %}
       <big>{{ term }}</big>{% elif freq < 30 %}
       <small>{{ term }}</small>{% else %}
       {{ term }}{% endif %}<small><sub>{{ freq }}</sub></small>
       {% endfor %}
       </div>
</div>
{% endif %}

{% if result.atypical %}
<div class="card">
  <div class="card-header">
    Other opinions
  </div>
       {% for sent in result.atypical %}
       <div class="card-body p-2">
       <p class="card-text">{{ sent.text }}</p>
       <p class="card-text"><small class="text-muted">by {{ sent.author }}
          {% if sent.date %} ({{ sent.date }}){% endif %} at {{ sent.domain }} </small>
       <small><br><a href="{{ sent.url }}">{{ sent.url }}</a></small>
       {% include "widgets/feedback_prompt.html" with site_name=sent.domain %}
       </p>
       </div>
       {% endfor %}
</div>
{% endif %}
</div>

<script defer>
var chartOptions = {
  labelInterpolationFnc: function(value) {
    return value[0]
  }
};
var chartResponsiveOptions = [
  ['screen and (min-width: 640px)', {
    chartPadding: 30,
    labelOffset: 100,
    labelDirection: 'explode',
    labelInterpolationFnc: function(value) {
      return value;
    }
  }],
  ['screen and (min-width: 1024px)', {
    labelOffset: 20,
    chartPadding: 20
  }]
];

{% if result.sitesStats %}
var sitesData = {
   labels: [{% for site in result.sitesStats %}'{{ site.site }}',{% endfor %}],
   series: [{% for site in result.sitesStats %}{{ site.frequency }},{% endfor %}]
};
new Chartist.Pie('#ct-chart-sites', sitesData, chartOptions, chartResponsiveOptions);
{% endif %}

{% if result.years %}
var years = [{% for y in result.years %}'{{ y }}',{% endfor %}];
var yearCounts = [{% for c in result.yearCounts %}{{ c }},{% endfor %}];
new Chartist.Line('#ct-chart-trend', {labels: years, series: [yearCounts]}, chartOptions);
{% endif %}
</script>

{% endif %}
{% endblock %}
